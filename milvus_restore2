import time
from pymilvus import connections, Collection, utility, FieldSchema, CollectionSchema, DataType

# --- Configuration ---
SOURCE_CONFIG = {
    "uri": "localhost:19530",
    "db_name": "default",
    "collection_name": "original_collection"
}

TARGET_CONFIG = {
    "uri": "localhost:19530",
    "db_name": "default",
    "collection_name": "restored_collection"
}

def backup_and_restore():
    # 1. Connect to Milvus
    connections.connect(alias="default", uri=SOURCE_CONFIG["uri"], db_name=SOURCE_CONFIG["db_name"])
    
    if not utility.has_collection(SOURCE_CONFIG["collection_name"]):
        print(f"Source collection {SOURCE_CONFIG['collection_name']} not found!")
        return

    # 2. Get Source Collection and Schema
    src_col = Collection(SOURCE_CONFIG["collection_name"])
    src_col.load()
    schema = src_col.schema
    
    # Identify all field names to ensure we don't miss the 'embeddings' field
    all_field_names = [field.name for field in schema.fields]
    print(f"Fields to migrate: {all_field_names}")

    # 3. Create Target Collection (using the same schema)
    if utility.has_collection(TARGET_CONFIG["collection_name"]):
        utility.drop_collection(TARGET_CONFIG["collection_name"])
    
    dest_col = Collection(name=TARGET_CONFIG["collection_name"], schema=schema)
    print(f"Created target collection: {TARGET_CONFIG['collection_name']}")

    # 4. Migrate Data
    # Explicitly asking for all fields ensures 'embeddings' is included in the result set
    print("Fetching data from source...")
    results = src_col.query(expr="", output_fields=all_field_names)
    
    if results:
        print(f"Inserting {len(results)} entities into {TARGET_CONFIG['collection_name']}...")
        dest_col.insert(results)
        dest_col.flush()
    else:
        print("No data found in source collection.")

    # 5. Create Specific Index (IVF_FLAT, L2, nlist 128)
    index_params = {
        "metric_type": "L2",
        "index_type": "IVF_FLAT",
        "params": {"nlist": 128}
    }
    
    print(f"Creating IVF_FLAT index on 'embeddings'...")
    dest_col.create_index(
        field_name="embeddings", 
        index_params=index_params
    )

    # 6. Load and Search Test
    dest_col.load()
    print("Collection loaded. Performing verification search...")

    # Mock search: using the first vector from our results as a query
    if results:
        search_vector = [results[0]["embeddings"]]
        search_params = {"metric_type": "L2", "params": {"nprobe": 10}}
        
        search_res = dest_col.search(
            data=search_vector, 
            anns_field="embeddings", 
            param=search_params, 
            limit=3,
            output_fields=all_field_names
        )
        
        for hits in search_res:
            for hit in hits:
                print(f"Hit: {hit.id}, Distance: {hit.distance}")

if __name__ == "__main__":
    backup_and_restore()
