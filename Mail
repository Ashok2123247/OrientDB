// Connect to database
const db = connect("mongodb://localhost:27017/alerts_db");
const collection = db.alerts;

// Define current time and day boundaries (UTC)
const now = new Date();
const startOfDay = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
const endOfDay = new Date(startOfDay);
endOfDay.setUTCDate(endOfDay.getUTCDate() + 1);

// Duration threshold in milliseconds (1 minute)
const MIN_DURATION_MS = 60 * 1000;

// Get current operations that are active, not idle, and not system ops
const currentOps = db.getSiblingDB("admin").currentOp({
    active: true,
    secs_running: { $gte: 60 },
    op: { $in: ["query", "command"] },
    "command.find": { $exists: true }
});

// Process and insert if not already inserted today
currentOps.inprog.forEach(op => {
    const queryStr = JSON.stringify(op.command);

    // Check for duplicate in today's alerts
    const exists = collection.findOne({
        query: queryStr,
        timestamp: {
            $gte: startOfDay,
            $lt: endOfDay
        }
    });

    if (!exists) {
        collection.insertOne({
            query: queryStr,
            timestamp: now,
            opid: op.opid,
            secs_running: op.secs_running
        });
        print("Inserted alert for long-running query: " + queryStr);
    } else {
        print("Skipped (already alerted today): " + queryStr);
    }
});
