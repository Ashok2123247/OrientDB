#!/bin/bash

# MongoDB parameters
MONGO_HOST="127.0.0.1"
MONGO_PORT="27017"
DB="admin"

# Email parameters
TO="recipient@example.com"
FROM="mongodb-monitor@example.com"
SUBJECT="MongoDB Long Running Operations Report"

# Temporary files
HTML_FILE=$(mktemp)
JS_FILE=$(mktemp)

# JavaScript to run in mongo shell
cat <<'EOF' > "$JS_FILE"
var results = db.currentOp({active:true}).inprog
    .filter(op => op.secs_running > 100 && op.command)
    .sort((a, b) => b.secs_running - a.secs_running);

print("<table border='1' cellpadding='5' cellspacing='0'>");
print("<tr><th>OpID</th><th>CurrentOptime</th><th>Type</th><th>Namespace</th><th>Host</th><th>NumYields</th><th>Seconds Running</th></tr>");

results.forEach(op => {
    print("<tr>"
        + "<td>" + op.opid + "</td>"
        + "<td>" + (op.currentOpTime || "") + "</td>"
        + "<td>" + op.type + "</td>"
        + "<td>" + op.ns + "</td>"
        + "<td>" + op.host + "</td>"
        + "<td>" + op.numYields + "</td>"
        + "<td>" + op.secs_running + "</td>"
        + "</tr>");
});

print("</table>");
EOF

# Run the JS in Mongo and store HTML table output
TABLE_HTML=$(mongo --quiet --host "$MONGO_HOST" --port "$MONGO_PORT" "$DB" "$JS_FILE")

# Create HTML Email Body
cat <<EOF > "$HTML_FILE"
From: $FROM
To: $TO
Subject: $SUBJECT
Content-Type: text/html

<html>
<head>
  <style>
    body { font-family: Arial, sans-serif; }
    table { border-collapse: collapse; width: 100%; }
    th { background-color: #f2f2f2; }
    th, td { text-align: left; padding: 8px; border: 1px solid #ddd; }
    tr:nth-child(even) { background-color: #f9f9f9; }
  </style>
</head>
<body>
  <h2>MongoDB Long Running Operations (&gt; 100 secs)</h2>
  $TABLE_HTML
</body>
</html>
EOF

# Send the email
sendmail -t < "$HTML_FILE"

# Clean up
rm -f "$HTML_FILE" "$JS_FILE"
