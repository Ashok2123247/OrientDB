import time
from pymilvus import connections, Collection, utility, db

# --- Configuration ---
SOURCE_CONFIG = {
    "uri": "localhost:19530",
    "db_name": "default",
    "collection_name": "original_collection"
}

TARGET_CONFIG = {
    "uri": "localhost:19530",
    "db_name": "default", # Changed to default for ease; change if needed
    "collection_name": "restored_collection"
}

def duplicate_collection():
    # 1. Connect to Source
    connections.connect(alias="source", uri=SOURCE_CONFIG["uri"], db_name=SOURCE_CONFIG["db_name"])
    
    if not utility.has_collection(SOURCE_CONFIG["collection_name"], using="source"):
        print(f"Source collection {SOURCE_CONFIG['collection_name']} not found!")
        return

    src_col = Collection(SOURCE_CONFIG["collection_name"], using="source")
    
    # --- FIX: Identify the vector field and all field names ---
    schema = src_col.schema
    all_field_names = [field.name for field in schema.fields]
    vector_field_name = next(field.name for field in schema.fields if field.dtype.name in ['FLOAT_VECTOR', 'BINARY_VECTOR'])
    
    print(f"Detected vector field: {vector_field_name}")

    # 2. Connect to Target
    connections.connect(alias="target", uri=TARGET_CONFIG["uri"], db_name=TARGET_CONFIG["db_name"])
    
    # 3. Drop target if it exists to avoid schema mismatch errors
    if utility.has_collection(TARGET_CONFIG["collection_name"], using="target"):
        utility.drop_collection(TARGET_CONFIG["collection_name"], using="target")

    # 4. Create New Collection
    dest_col = Collection(
        name=TARGET_CONFIG["collection_name"],
        schema=schema,
        using="target"
    )
    print(f"Created collection: {TARGET_CONFIG['collection_name']}")

    # 5. Migrate Data with explicit field selection
    # We explicitly request all fields, including the vector field
    results = src_col.query(expr="", output_fields=all_field_names)
    
    if results:
        # Check if any data is missing for the vector field
        if vector_field_name not in results[0]:
            print(f"Error: Vector data for '{vector_field_name}' was not retrieved.")
            return

        dest_col.insert(results)
        dest_col.flush()
        print(f"Successfully migrated {len(results)} entities.")

    # 6. Recreate Indexes
    # Note: We must recreate the index BEFORE loading for search performance
    for idx in src_col.indexes:
        idx_dict = idx.to_dict()
        dest_col.create_index(
            field_name=idx_dict['field_name'], 
            index_params=idx_dict['index_param']
        )
        print(f"Index recreated on: {idx_dict['field_name']}")

    # 7. Load and Verify
    dest_col.load()
    print("Collection loaded successfully.")
    
    # Verification Query
    res = dest_col.query(expr="", limit=1, output_fields=[vector_field_name])
    print("Verification peek:", res)

if __name__ == "__main__":
    duplicate_collection()
