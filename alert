#!/bin/bash

# Configuration
MONGO_LOG="/var/log/mongodb/mongod.log"  # Adjust path as needed
ALERTED_LOG="/var/log/mongodb/alerted_queries_$(date +%F).log"
TMP_QUERIES="/tmp/long_queries.tmp"
ALERT_THRESHOLD=60000  # 60 seconds in milliseconds
TIME_WINDOW_MINUTES=10

# Get the timestamp from 10 minutes ago
START_TIME=$(date -d "-$TIME_WINDOW_MINUTES minutes" "+%Y-%m-%dT%H:%M:%S")

# Filter logs from the last 10 minutes and long running queries (> 60s)
grep -F "\"command\"" "$MONGO_LOG" | awk -v start="$START_TIME" '$0 >= start' | \
    jq -c 'select(.attr != null and .attr.millis != null and .attr.millis > '"$ALERT_THRESHOLD"')' > "$TMP_QUERIES"

# Loop through each long-running query
while IFS= read -r line; do
    # Extract key fields to form a unique hash (you can adjust the fields)
    query=$(echo "$line" | jq -r '.attr.command')
    ns=$(echo "$line" | jq -r '.attr.ns')
    millis=$(echo "$line" | jq -r '.attr.millis')

    # Combine fields and hash
    hash=$(echo "$query-$ns" | md5sum | awk '{print $1}')

    # Check if this hash is already alerted
    if ! grep -q "$hash" "$ALERTED_LOG" 2>/dev/null; then
        # Not alerted today, so alert and log it
        echo "ALERT: Long running query in $ns ($millis ms)"
        echo "$hash" >> "$ALERTED_LOG"
    else
        echo "SKIP: Already alerted today for $ns"
    fi
done < "$TMP_QUERIES"

# Cleanup
rm -f "$TMP_QUERIES"
