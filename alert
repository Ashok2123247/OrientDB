#!/bin/bash

LOG_FILE="/path/to/mongodb.log"  # Replace with the actual MongoDB log file path
ALERT_THRESHOLD=60  # Seconds
EXEMPTION_INTERVAL=600  # 10 minutes in seconds
TMP_FILE="/tmp/query_log.tmp"

# Extract long-running queries without using jq
grep -E '"durationMillis": ([6-9][0-9]{1,2}|[1-9][0-9]{3,})' "$LOG_FILE" | while read -r line; do
    QUERY=$(echo "$line" | sed -n 's/.*"query": {\([^}]*\)}.*/\1/p')
    TIMESTAMP=$(echo "$line" | sed -n 's/.*"timestamp": "\([^"]*\)".*/\1/p')

    if [[ -n "$QUERY" && -n "$TIMESTAMP" ]]; then
        LAST_OCCURRENCE=$(grep "$QUERY" "$TMP_FILE" | tail -1 | awk '{print $1}')
        CURRENT_TIME=$(date -d "$TIMESTAMP" +%s)

        if [[ -z "$LAST_OCCURRENCE" || $((CURRENT_TIME - LAST_OCCURRENCE)) -gt $EXEMPTION_INTERVAL ]]; then
            echo "$CURRENT_TIME $QUERY" >> "$TMP_FILE"
            echo "ALERT: Query taking more than $ALERT_THRESHOLD seconds detected: $QUERY"
        fi
    fi
done







#!/bin/bash

LOG_FILE="/var/log/mongodb/mongod.log"
TMP_DIR="/tmp/mongo_query_alert"
mkdir -p "$TMP_DIR"
HISTORY_FILE="$TMP_DIR/query_history.txt"
ALERT_LOG="$TMP_DIR/alerts.log"

# Get the last 5 minutes of logs (tune as needed)
tail -n 10000 "$LOG_FILE" | grep -E 'command.*durationMillis' | \
awk '
{
    # Extract timestamp, query string and durationMillis
    match($0, /\[([^\]]+)\]/, ts_arr)
    timestamp = ts_arr[1]

    match($0, /command ([^ ]+)/, cmd_arr)
    command = cmd_arr[1]

    match($0, /query: ({.*}),.*planSummary/, query_arr)
    query_text = query_arr[1]

    match($0, /durationMillis: ([0-9]+)/, dur_arr)
    duration = dur_arr[1] + 0

    if (duration >= 60000) {
        # Construct a unique hash key from command + query
        query_key = command ":" query_text
        gsub(/[ \t\r\n]+/, "", query_key)
        print timestamp "|" query_key "|" duration
    }
}' | while IFS="|" read -r timestamp query_key duration; do
    # Normalize key
    hash=$(echo "$query_key" | md5sum | awk '{print $1}')

    now_epoch=$(date -d "$timestamp" +%s 2>/dev/null)
    [ -z "$now_epoch" ] && continue

    # Check if it's been alerted recently
    last_alert_time=$(grep "$hash" "$HISTORY_FILE" | cut -d "|" -f 2)

    if [ -n "$last_alert_time" ]; then
        diff=$((now_epoch - last_alert_time))
        if [ "$diff" -lt 600 ]; then
            # Skip alerting
            continue
        fi
    fi

    # Log the alert
    echo "[$(date)] ALERT: Slow Query > 60s: $query_key (Duration: $duration ms)" >> "$ALERT_LOG"
    echo "$hash|$now_epoch" >> "$HISTORY_FILE"

    # Optional: Send alert (e.g., mail, webhook)
    echo "ALERT: Slow Query > 60s: $query_key (Duration: $duration ms)"
done

# Keep history clean (only keep recent)
awk -v cutoff="$(date +%s --date='-12 hours')" -F"|" '$2 > cutoff' "$HISTORY_FILE" > "$HISTORY_FILE.tmp"
mv "$HISTORY_FILE.tmp" "$HISTORY_FILE"

